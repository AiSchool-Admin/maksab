/**
 * POST /api/chatbot
 * AI-powered chatbot for Maksab customer support.
 * Uses a rule-based + keyword matching system for fast responses.
 */

import { NextRequest, NextResponse } from "next/server";

interface ChatMessage {
  role: "user" | "assistant";
  content: string;
}

// Knowledge base for Maksab-specific questions
const knowledgeBase: { keywords: string[]; response: string }[] = [
  {
    keywords: ["Ù…ÙƒØ³Ø¨", "Ø§Ù„ØªØ·Ø¨ÙŠÙ‚", "Ø§ÙŠÙ‡", "Ø§ÙŠ", "Ø´Ø±Ø­"],
    response:
      "Ù…ÙƒØ³Ø¨ Ù‡Ùˆ Ø³ÙˆÙ‚ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…ØµØ±ÙŠ Ù„Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ ÙˆØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ù„Ù…Ø³ØªØ¹Ù…Ù„Ø©. Ø´Ø¹Ø§Ø±Ù†Ø§ \"ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨\" â€” ÙŠØ¹Ù†ÙŠ ÙƒÙ„ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØªØ¹Ø§Ù…Ù„ÙˆØ§ Ù…Ø¹Ø§Ù†Ø§ ÙƒØ³Ø¨Ø§Ù†ÙŠÙ†!",
  },
  {
    keywords: ["Ø§Ø¶Ù", "Ø§Ø¹Ù„Ø§Ù†", "Ø§Ù†Ø´Ø±", "Ø¨ÙŠØ¹", "Ø§Ø²Ø§ÙŠ Ø§Ø¨ÙŠØ¹"],
    response:
      "Ø¹Ø´Ø§Ù† ØªØ¶ÙŠÙ Ø¥Ø¹Ù„Ø§Ù†:\n1. Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± \"+\" Ø£Ø¶Ù Ø¥Ø¹Ù„Ø§Ù† Ù…Ù† Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ\n2. Ø§Ø®ØªØ§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (Ø³ÙŠØ§Ø±Ø§ØªØŒ Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§ØªØŒ Ø¹Ù‚Ø§Ø±Ø§Øª...)\n3. Ø§Ù…Ù„Ø£ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©\n4. Ø­Ø¯Ø¯ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±\n5. Ø§Ø®ØªØ§Ø± Ù…ÙˆÙ‚Ø¹Ùƒ ÙˆØ§Ø¶ØºØ· \"Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†\"\n\nØ§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ù…Ø´ Ø¨ÙŠØ§Ø®Ø¯ Ø£ÙƒØªØ± Ù…Ù† Ø¯Ù‚ÙŠÙ‚Ø©!",
  },
  {
    keywords: ["Ù…Ø²Ø§Ø¯", "Ù…Ø²Ø§ÙŠØ¯Ø©", "Ø§Ø²Ø§ÙŠ Ø§Ø²Ø§ÙŠØ¯", "ÙƒÙŠÙ Ø§Ø²Ø§ÙŠØ¯"],
    response:
      "Ø§Ù„Ù…Ø²Ø§Ø¯ ÙÙŠ Ù…ÙƒØ³Ø¨ Ø¨ÙŠØ´ØªØºÙ„ ÙƒØ¯Ù‡:\nâ€¢ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¨ÙŠØ­Ø¯Ø¯ Ø³Ø¹Ø± Ø§ÙØªØªØ§Ø­ ÙˆÙ…Ø¯Ø© Ø§Ù„Ù…Ø²Ø§Ø¯ (24 Ø£Ùˆ 48 Ø£Ùˆ 72 Ø³Ø§Ø¹Ø©)\nâ€¢ Ø£Ù†Øª Ø¨ØªØ²Ø§ÙŠØ¯ Ø¨Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ²Ù‡ (Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† Ø£Ø¹Ù„Ù‰ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰)\nâ€¢ Ù„Ùˆ Ø­Ø¯ Ø²Ø§ÙŠØ¯ ÙÙŠ Ø¢Ø®Ø± 5 Ø¯Ù‚Ø§Ø¦Ù‚ØŒ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø¨ÙŠØªÙ…Ø¯Ø¯ 5 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ù…Ø²Ø§ÙŠØ¯Ø© Ø§Ù„Ù…ØªØ£Ø®Ø±Ø©)\nâ€¢ Ù…Ù…ÙƒÙ† ØªØ´ØªØ±ÙŠ ÙÙˆØ±Ø§Ù‹ Ø¨Ø³Ø¹Ø± \"Ø§Ø´ØªØ±ÙŠ Ø§Ù„Ø¢Ù†\" Ù„Ùˆ Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø­Ø¯Ø¯Ù‡",
  },
  {
    keywords: ["Ù…Ø¨Ø§Ø´Ø±", "Ø¨Ø«", "Ù„Ø§ÙŠÙ", "live"],
    response:
      "Ø§Ù„Ù…Ø²Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ) Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…ÙƒØ³Ø¨! Ø§Ù„Ø¨Ø§Ø¦Ø¹ Ø¨ÙŠÙ‚Ø¯Ø± ÙŠØ¹Ù…Ù„ Ø¨Ø« Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ. Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯ÙŠÙ† Ø¨ÙŠÙ‚Ø¯Ø±ÙˆØ§ ÙŠØ²Ø§ÙŠØ¯ÙˆØ§ ÙˆÙ‡Ù…Ø§ Ø¨ÙŠØªÙØ±Ø¬ÙˆØ§.\n\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ø§Ù„Ù…Ø²Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ù„ÙŠÙ‡ Ø±Ø³ÙˆÙ… Ø¥Ø¶Ø§ÙÙŠØ© (50 Ø¬Ù†ÙŠÙ‡ + 2% Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹).",
  },
  {
    keywords: ["ØªØ¨Ø¯ÙŠÙ„", "ØªØ¨Ø§Ø¯Ù„", "Ø¨Ø¯Ù„"],
    response:
      "Ù…ÙŠØ²Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ØªØ³Ù…Ø­Ù„Ùƒ ØªØ¹Ø±Ø¶ Ø³Ù„Ø¹ØªÙƒ Ù„Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨Ø³Ù„Ø¹Ø© ØªØ§Ù†ÙŠØ© Ø¨Ø¯Ù„ Ø§Ù„Ø¨ÙŠØ¹. Ù…Ø«Ù„Ø§Ù‹ Ø¹Ø§ÙŠØ² ØªØ¨Ø¯Ù„ Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ Ø¨Ù…ÙˆØ¨Ø§ÙŠÙ„ ØªØ§Ù†ÙŠ.\n\nÙ„Ù…Ø§ ØªØ¶ÙŠÙ Ø¥Ø¹Ù„Ø§Ù†ØŒ Ø§Ø®ØªØ§Ø± \"ØªØ¨Ø¯ÙŠÙ„\" ÙƒÙ†ÙˆØ¹ Ø§Ù„Ø¨ÙŠØ¹ ÙˆØ§ÙƒØªØ¨ Ø¥ÙŠÙ‡ Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ² ØªØ¨Ø¯Ù„ Ø¨ÙŠÙ‡. Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù‡ÙŠÙ‚ØªØ±Ø­Ù„Ùƒ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙƒÙ† ØªØªØ¨Ø¯Ù„ Ù…Ø¹Ø§Ù‡Ø§!",
  },
  {
    keywords: ["Ø±Ø³ÙˆÙ…", "Ø¹Ù…ÙˆÙ„Ø©", "ÙÙ„ÙˆØ³", "Ù…Ø¬Ø§Ù†ÙŠ", "ØªÙƒÙ„ÙØ©"],
    response:
      "Ù…ÙƒØ³Ø¨ ØªØ·Ø¨ÙŠÙ‚ Ù…Ø¬Ø§Ù†ÙŠ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„! Ù…ÙÙŠØ´ Ø£ÙŠ Ø±Ø³ÙˆÙ… Ø¹Ù„Ù‰ Ù†Ø´Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø£Ùˆ Ø§Ù„Ø¨ÙŠØ¹ Ø§Ù„Ø¹Ø§Ø¯ÙŠ.\n\nØ¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„ØµÙÙ‚Ø© ØªØªÙ…ØŒ Ø¨Ù†Ø³Ø£Ù„Ùƒ Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ³Ø§Ù‡Ù… Ø¨Ø¹Ù…ÙˆÙ„Ø© Ø¨Ø³ÙŠØ·Ø© ØªØ³Ø§Ø¹Ø¯Ù†Ø§ Ù†ÙƒØ¨Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© 100%).\n\nØ§Ù„Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù‡Ùˆ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø± (Ø§Ù„Ø¨Ø« Ø§Ù„Ø­ÙŠ) â€” Ø¹Ù„ÙŠÙ‡ Ø±Ø³ÙˆÙ… 50 Ø¬Ù†ÙŠÙ‡ + 2%.",
  },
  {
    keywords: ["ØªØ³Ø¬ÙŠÙ„", "Ø­Ø³Ø§Ø¨", "Ø¯Ø®ÙˆÙ„", "Ù„ÙˆØ¬Ù†", "Ø±Ù‚Ù…", "Ù…ÙˆØ¨Ø§ÙŠÙ„"],
    response:
      "Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø³Ù‡Ù„ Ø¬Ø¯Ø§Ù‹ â€” Ø¨Ø³ Ù…Ø­ØªØ§Ø¬ Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ Ø§Ù„Ù…ØµØ±ÙŠ (01XXXXXXXXX). Ù‡Ù†Ø¨Ø¹ØªÙ„Ùƒ ÙƒÙˆØ¯ ØªØ£ÙƒÙŠØ¯ SMS ÙˆØ¨ÙƒØ¯Ù‡ Ø­Ø³Ø§Ø¨Ùƒ Ø¬Ø§Ù‡Ø²!\n\nÙ…Ø´ Ù…Ø­ØªØ§Ø¬ ØªØ³Ø¬Ù„ Ø¹Ø´Ø§Ù† ØªØªØµÙØ­ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ù…Ø·Ù„ÙˆØ¨ Ø¨Ø³ Ù„Ù…Ø§ ØªÙŠØ¬ÙŠ ØªØ¶ÙŠÙ Ø¥Ø¹Ù„Ø§Ù† Ø£Ùˆ ØªØ¨Ø¹Øª Ø±Ø³Ø§Ù„Ø© Ø£Ùˆ ØªØ²Ø§ÙŠØ¯.",
  },
  {
    keywords: ["Ø¯ÙØ¹", "ÙÙ„ÙˆØ³", "ØªØ­ÙˆÙŠÙ„", "ÙÙˆØ¯Ø§ÙÙˆÙ†", "Ø§Ù†Ø³ØªØ§Ø¨Ø§ÙŠ", "instapay"],
    response:
      "Ø­Ø§Ù„ÙŠØ§Ù‹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø¨ÙŠÙƒÙˆÙ† Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠ Ù…Ø¨Ø§Ø´Ø±Ø©. Ù…ÙƒØ³Ø¨ Ù…Ø´ Ø¨ÙŠØªØ¯Ø®Ù„ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹.\n\nØ§Ù„Ø·Ø±Ù‚ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©: ÙƒØ§Ø´ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…ØŒ ÙÙˆØ¯Ø§ÙÙˆÙ† ÙƒØ§Ø´ØŒ Ø¥Ù†Ø³ØªØ§Ø¨Ø§ÙŠØŒ Ø£Ùˆ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ.\n\nÙ†ØµÙŠØ­Ø©: Ø§Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ø¯ÙØ¹ Ø¢Ù…Ù†Ø© ÙˆÙ…Ø¹Ø§ÙŠÙ† Ø§Ù„Ø³Ù„Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¯ÙØ¹.",
  },
  {
    keywords: ["Ø´ÙƒÙˆÙ‰", "Ù…Ø´ÙƒÙ„Ø©", "Ø¨Ù„Ø§Øº", "Ù†ØµØ¨", "Ø§Ø­ØªÙŠØ§Ù„"],
    response:
      "Ù„Ùˆ ÙˆØ§Ø¬Ù‡ØªÙƒ Ø£ÙŠ Ù…Ø´ÙƒÙ„Ø© Ø£Ùˆ Ø´ÙƒÙŠØª ÙÙŠ Ø¥Ø¹Ù„Ø§Ù†:\nâ€¢ Ø§Ø³ØªØ®Ø¯Ù… Ø²Ø± \"Ø¥Ø¨Ù„Ø§Øº\" ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†\nâ€¢ ØªØ¬Ù†Ø¨ Ø§Ù„Ø¯ÙØ¹ Ù…Ù‚Ø¯Ù…Ø§Ù‹ Ù‚Ø¨Ù„ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ø³Ù„Ø¹Ø©\nâ€¢ Ù‚Ø§Ø¨Ù„ Ø§Ù„Ø¨Ø§Ø¦Ø¹ ÙÙŠ Ù…ÙƒØ§Ù† Ø¹Ø§Ù…\nâ€¢ Ø§ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ù„Ø¹Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡\n\nØ³Ù„Ø§Ù…ØªÙƒ Ø£Ù‡Ù… Ø­Ø§Ø¬Ø© Ø¹Ù†Ø¯Ù†Ø§!",
  },
  {
    keywords: ["Ø§Ù‚Ø³Ø§Ù…", "Ù‚Ø³Ù…", "ÙØ¦Ø§Øª", "Ø¨ÙŠØ¹ Ø§ÙŠÙ‡"],
    response:
      "Ù…ÙƒØ³Ø¨ ÙÙŠÙ‡ 12 Ù‚Ø³Ù…:\nğŸš— Ø³ÙŠØ§Ø±Ø§Øª\nğŸ  Ø¹Ù‚Ø§Ø±Ø§Øª\nğŸ“± Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª ÙˆØªØ§Ø¨Ù„Øª\nğŸ‘— Ù…ÙˆØ¶Ø©\nâ™»ï¸ Ø®Ø±Ø¯Ø©\nğŸ’° Ø°Ù‡Ø¨ ÙˆÙØ¶Ø©\nğŸ’ Ø³Ù„Ø¹ ÙØ§Ø®Ø±Ø©\nğŸ  Ø£Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©\nğŸª‘ Ø£Ø«Ø§Ø« ÙˆØ¯ÙŠÙƒÙˆØ±\nğŸ® Ù‡ÙˆØ§ÙŠØ§Øª\nğŸ”§ Ø¹Ø¯Ø¯ ÙˆØ£Ø¯ÙˆØ§Øª\nğŸ› ï¸ Ø®Ø¯Ù…Ø§Øª",
  },
  {
    keywords: ["Ø¨Ø­Ø«", "Ø§Ø¨Ø­Ø«", "Ø¯ÙˆØ±", "Ø§Ù„Ø§Ù‚ÙŠ"],
    response:
      "Ø¹Ø´Ø§Ù† ØªÙ„Ø§Ù‚ÙŠ Ø§Ù„Ù„ÙŠ Ø¨ØªØ¯ÙˆØ± Ø¹Ù„ÙŠÙ‡:\n1. Ø§Ø³ØªØ®Ø¯Ù… Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©\n2. Ø§ÙƒØªØ¨ Ø§Ù„Ù„ÙŠ Ø¹Ø§ÙŠØ²Ù‡ Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ (Ù…Ø«Ù„Ø§Ù‹: Ø¢ÙŠÙÙˆÙ† 15ØŒ Ø´Ù‚Ø© Ù…Ø¯ÙŠÙ†Ø© Ù†ØµØ±)\n3. Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙÙ„Ø§ØªØ± Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¹Ø± ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹ ÙˆØ§Ù„Ø­Ø§Ù„Ø©\n4. Ø±ØªØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø£Ø­Ø¯Ø« Ø£Ùˆ Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„ÙŠÙƒ",
  },
  {
    keywords: ["Ø§Ù„Ù…ÙØ¶Ù„Ø©", "Ø­ÙØ¸", "Ù‚Ù„Ø¨"],
    response:
      "Ø¹Ø´Ø§Ù† ØªØ­ÙØ¸ Ø¥Ø¹Ù„Ø§Ù† ÙÙŠ Ø§Ù„Ù…ÙØ¶Ù„Ø©ØŒ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‚Ù„Ø¨ â™¡ Ø¹Ù„Ù‰ Ø£ÙŠ Ø¥Ø¹Ù„Ø§Ù†. Ù‡ØªÙ„Ø§Ù‚ÙŠ ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ ØµÙØ­Ø© Ø­Ø³Ø§Ø¨Ùƒ.",
  },
];

function findBestResponse(userMessage: string): string {
  const lowerMsg = userMessage.toLowerCase();

  // Check greetings
  const greetings = ["Ø³Ù„Ø§Ù…", "Ø§Ù‡Ù„Ø§", "Ù…Ø±Ø­Ø¨Ø§", "Ù‡Ø§ÙŠ", "ØµØ¨Ø§Ø­", "Ù…Ø³Ø§Ø¡", "Ø§Ø²ÙŠÙƒ", "Ø¹Ø§Ù…Ù„"];
  if (greetings.some((g) => lowerMsg.includes(g))) {
    return "Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙÙŠ Ù…ÙƒØ³Ø¨! ğŸ’š Ø£Ù†Ø§ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø°ÙƒÙŠ Ø¨ØªØ§Ø¹ Ù…ÙƒØ³Ø¨. Ù…Ù…ÙƒÙ† Ø£Ø³Ø§Ø¹Ø¯Ùƒ ÙÙŠ Ø¥ÙŠÙ‡ Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø©ØŸ\n\nÙ…Ù…ÙƒÙ† ØªØ³Ø£Ù„Ù†ÙŠ Ø¹Ù†:\nâ€¢ Ø¥Ø²Ø§ÙŠ ØªØ¶ÙŠÙ Ø¥Ø¹Ù„Ø§Ù†\nâ€¢ Ø¥Ø²Ø§ÙŠ ØªØ²Ø§ÙŠØ¯ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ø¯\nâ€¢ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©\nâ€¢ Ø£Ùˆ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ØªØ§Ù†ÙŠ!";
  }

  // Check thanks
  const thanks = ["Ø´ÙƒØ±Ø§", "Ø´ÙƒØ±", "ØªØ³Ù„Ù…", "Ù…ÙŠØ±Ø³ÙŠ", "thanks"];
  if (thanks.some((t) => lowerMsg.includes(t))) {
    return "Ø§Ù„Ø¹ÙÙˆ! ğŸ’š Ù„Ùˆ Ù…Ø­ØªØ§Ø¬ Ø£ÙŠ Ø­Ø§Ø¬Ø© ØªØ§Ù†ÙŠØ© Ø£Ù†Ø§ Ù…ÙˆØ¬ÙˆØ¯. ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨!";
  }

  // Score each knowledge base entry
  let bestMatch = { score: 0, response: "" };

  for (const entry of knowledgeBase) {
    let score = 0;
    for (const keyword of entry.keywords) {
      if (lowerMsg.includes(keyword)) {
        score += keyword.length; // Longer keyword matches = more specific
      }
    }
    if (score > bestMatch.score) {
      bestMatch = { score, response: entry.response };
    }
  }

  if (bestMatch.score > 0) {
    return bestMatch.response;
  }

  // Default fallback
  return "Ù…Ø´ Ù…ØªØ£ÙƒØ¯ Ø¥Ù†ÙŠ ÙÙ‡Ù…Øª Ø³Ø¤Ø§Ù„Ùƒ. Ù…Ù…ÙƒÙ† ØªØ¬Ø±Ø¨ ØªØ³Ø£Ù„Ù†ÙŠ Ø¹Ù†:\nâ€¢ Ø¥Ø²Ø§ÙŠ ØªØ¶ÙŠÙ Ø¥Ø¹Ù„Ø§Ù†\nâ€¢ Ø¥Ø²Ø§ÙŠ ÙŠØ´ØªØºÙ„ Ø§Ù„Ù…Ø²Ø§Ø¯\nâ€¢ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø© ÙÙŠ Ù…ÙƒØ³Ø¨\nâ€¢ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¯ÙØ¹\nâ€¢ Ø§Ù„Ù…Ø²Ø§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±\n\nØ£Ùˆ Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ø¨Ø·Ø±ÙŠÙ‚Ø© ØªØ§Ù†ÙŠØ© ÙˆÙ‡Ø­Ø§ÙˆÙ„ Ø£Ø³Ø§Ø¹Ø¯Ùƒ!";
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { message, history } = body as {
      message: string;
      history?: ChatMessage[];
    };

    if (!message || typeof message !== "string" || message.trim().length === 0) {
      return NextResponse.json(
        { error: "Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙØ§Ø¶ÙŠØ©" },
        { status: 400 },
      );
    }

    const response = findBestResponse(message.trim());

    return NextResponse.json({
      response,
      timestamp: new Date().toISOString(),
    });
  } catch {
    return NextResponse.json(
      { error: "Ø­ØµÙ„Øª Ù…Ø´ÙƒÙ„Ø©. Ø¬Ø±Ø¨ ØªØ§Ù†ÙŠ" },
      { status: 500 },
    );
  }
}
