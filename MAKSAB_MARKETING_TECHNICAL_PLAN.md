# Ù…ÙƒØ³Ø¨ â€” Ø§Ù„Ø®Ø·Ø© Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
# Maksab â€” Complete Marketing Technical Implementation Plan
# CMO: AI-Powered | Developer: Claude Code

---

> **Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù‡Ùˆ Ø§Ù„Ù…Ø±Ø¬Ø¹ Ø§Ù„ÙˆØ­ÙŠØ¯ Ù„ÙƒÙ„ Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠ Ø§Ù„ØªÙ‚Ù†ÙŠ ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ Ù…ÙƒØ³Ø¨.**
> **Claude Code: Ø§Ù‚Ø±Ø£ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ØŒ Ø«Ù… Ù†ÙÙ‘Ø° Ø§Ù„Ù…Ù‡Ø§Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù€ Sprint.**

---

## Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
1. [Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø§Ù„ØªÙ‚Ù†ÙŠØ©](#-Ù…Ø¹Ù„ÙˆÙ…Ø§Øª-Ø§Ù„Ù…Ø´Ø±ÙˆØ¹)
2. [Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ â€” Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ](#-Ø§Ù„ØªØ­Ù„ÙŠÙ„-Ø§Ù„Ø­Ø§Ù„ÙŠ)
3. [Sprint 1 â€” Analytics + Tracking + SEO](#-sprint-1--Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹-1-2)
4. [Sprint 2 â€” Growth Loops + Conversion](#-sprint-2--Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹-3-4)
5. [Sprint 3 â€” Gamification + Advanced Analytics](#-sprint-3--Ø§Ù„Ø´Ù‡Ø±-2)
6. [Environment Variables](#-environment-variables)
7. [ØªØ¹Ù„ÙŠÙ…Ø§Øª CLAUDE.md Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©](#-ØªØ¹Ù„ÙŠÙ…Ø§Øª-claude-Ù„Ù„ØªØ³ÙˆÙŠÙ‚)
8. [Marketing Events Standard](#-marketing-events-standard)
9. [KPIs ÙˆÙ…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡](#-kpis)
10. [Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØªØ®ØµÙŠØµÙ‡Ø§](#-Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©)

---

## ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙˆØ¹

| Ø§Ù„Ø¨Ù†Ø¯ | Ø§Ù„Ù‚ÙŠÙ…Ø© |
|-------|--------|
| **Ø§Ù„Ù…Ø´Ø±ÙˆØ¹** | Ù…ÙƒØ³Ø¨ â€” ØªØ·Ø¨ÙŠÙ‚ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¨ÙˆØ¨Ø© Ù…ØµØ±ÙŠ |
| **Ø§Ù„Ø´Ø¹Ø§Ø±** | ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨ |
| **Ø§Ù„Ø±Ø§Ø¨Ø·** | https://maksab.vercel.app |
| **GitHub** | https://github.com/AiSchool-Admin/maksab |
| **Framework** | Next.js 16.1.6 (App Router) |
| **UI** | React 19.2.4 + Tailwind CSS 4.1.18 |
| **Backend** | Supabase (PostgreSQL + Auth + Realtime + Edge Functions) |
| **State** | Zustand 5.0.11 |
| **PWA** | next-pwa 5.6.0 |
| **Push** | Firebase Cloud Messaging |
| **Error Tracking** | Sentry (client + server + edge) |
| **Maps** | Leaflet 1.9.4 |
| **Forms** | React Hook Form 7.71.1 + Zod |
| **Animations** | Framer Motion |
| **Deploy** | Vercel (primary) + Railway |
| **Ø§Ù„Ù„ØºØ©** | Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ© â€” RTL-native |
| **Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±** | Ù…ØµØ± â€” 18-45 Ø³Ù†Ø© â€” Ù…ÙˆØ¨Ø§ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹ |

### Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:
Ø³ÙŠØ§Ø±Ø§ØªØŒ Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§ØªØŒ Ø°Ù‡Ø¨ØŒ Ø£Ø«Ø§Ø«ØŒ Ø®Ø±Ø¯Ø©ØŒ Ø§Ù„Ù…ÙˆØ¶Ø©ØŒ Ø§Ù„Ø³Ù„Ø¹ Ø§Ù„ÙØ§Ø®Ø±Ø©ØŒ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ù†Ø²Ù„ÙŠØ©ØŒ Ø§Ù„Ù‡ÙˆØ§ÙŠØ§Øª

### Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©:
`/` `/ad/[id]` `/search` `/stores` `/store/[id]` `/login` `/setup` `/profile` `/settings` `/favorites` `/collections` `/my-ads` `/my-offers` `/chat` `/price-scanner` `/map` `/ambassador` `/rewards` `/invite` `/auctions` `/admin` `/help` `/privacy` `/terms` `/campaign/[slug]`

---

## ğŸ” Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ

### âœ… Ù…Ø§ Ù‡Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙŠØ¹Ù…Ù„:
- [x] Next.js 16 App Router Ù…Ø¹ SSR/SSG
- [x] Supabase Auth (Ø±Ù‚Ù… Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…ØµØ±ÙŠ +20)
- [x] PWA Ø¬Ø§Ù‡Ø² (next-pwa)
- [x] Firebase (Push notifications infrastructure)
- [x] Sentry Error Tracking
- [x] Leaflet Maps
- [x] Chat system
- [x] Auction system
- [x] Price Scanner (AI-powered)
- [x] Ambassador program page
- [x] Rewards page
- [x] Invite system page

### âŒ Ù…Ø§ Ù‡Ùˆ Ù†Ø§Ù‚Øµ (Ø§Ù„ÙØ¬ÙˆØ§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ© Ø§Ù„Ø­Ø±Ø¬Ø©):

| # | Ø§Ù„ÙØ¬ÙˆØ© | Ø§Ù„ØªØ£Ø«ÙŠØ± | Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© |
|---|--------|---------|----------|
| 1 | Google Analytics 4 | Ù„Ø§ tracking Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† â€” Ø¨Ù†Ø´ØªØºÙ„ Ø£Ø¹Ù…Ù‰! | **P0** |
| 2 | Meta Pixel + CAPI | Ù„Ø§ Conversion tracking â€” Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ø¨Ø¯ÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª | **P0** |
| 3 | TikTok Pixel | Ù„Ø§ tracking Ù„Ø­Ù…Ù„Ø§Øª TikTok | **P0** |
| 4 | UTM Tracking | Ù…Ø´ Ø¹Ø§Ø±ÙÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø§ÙŠ Ù…Ù† Ø£Ù†Ù‡ÙŠ Ø­Ù…Ù„Ø© | **P0** |
| 5 | SEO Dynamic Metadata | ØµÙØ­Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¨Ø¯ÙˆÙ† metadata â€” Google Ù…Ø´ Ø´Ø§ÙŠÙÙ‡Ø§ | **P0** |
| 6 | Dynamic Sitemap | Google Ù…Ø´ Ø¹Ø§Ø±Ù ÙŠÙ„Ø§Ù‚ÙŠ ØµÙØ­Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª | **P0** |
| 7 | OG Images Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© | Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨/ÙÙŠØ³Ø¨ÙˆÙƒ Ø´ÙƒÙ„Ù‡Ø§ ÙˆØ­Ø´ | **P0** |
| 8 | PWA Install Prompt | Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ø´ Ø¹Ø§Ø±ÙÙŠÙ† ÙŠØ­Ù…Ù„ÙˆØ§ ÙƒÙ€ App | **P0** |
| 9 | Referral System Backend | ØµÙØ­Ø© /invite Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Tracking ÙƒØ§Ù…Ù„ | **P0** |
| 10 | A/B Testing | Ù„Ø§ ØªØ¬Ø§Ø±Ø¨ â€” ÙƒÙ„ Ù‚Ø±Ø§Ø± Ø¨Ø§Ù„Ø­Ø¯Ø³ | **P1** |
| 11 | Structured Data JSON-LD | Ù…ÙÙŠØ´ Rich Snippets ÙÙŠ Google | **P1** |
| 12 | Push Notification Campaigns | Firebase Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† Campaign system | **P1** |
| 13 | Onboarding Flow | Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ù…Ù†Ø®ÙØ¶ | **P1** |
| 14 | CRO â€” ØªØ­Ø³ÙŠÙ† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† | Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ ØºÙŠØ± Ù…Ù‚Ø§Ø³ ÙˆÙ…Ø´ Ù…Ø­Ø³Ù‘Ù† | **P1** |
| 15 | Landing Pages | Ù…Ø­ØªØ§Ø¬ ØµÙØ­Ø§Øª Ù‡Ø¨ÙˆØ· Ù„Ù„Ø­Ù…Ù„Ø§Øª Ø§Ù„ØªØ³ÙˆÙŠÙ‚ÙŠØ© | **P1** |
| 16 | Email Collection | Ù…ÙÙŠØ´ Email capture â€” Ø¶Ø§ÙŠØ¹ÙŠÙ† leads | **P1** |
| 17 | WhatsApp Share | Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¹Ù„Ù‰ ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ø´ Ù…Ø­Ø³Ù‘Ù†Ø© | **P1** |
| 18 | Gamification Engine | Ù…ÙÙŠØ´ Ù†Ù‚Ø§Ø· Ø£Ùˆ Ù…Ø³ØªÙˆÙŠØ§Øª â€” Ù„Ø§ Ø¯Ø§ÙØ¹ Ù„Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± | **P2** |
| 19 | PostHog / Mixpanel | Ù„Ø§ Funnel analysis Ø£Ùˆ Session Recording | **P2** |
| 20 | Seller Analytics | Ø§Ù„Ø¨Ø§Ø¦Ø¹ÙŠÙ† Ù…Ø´ Ø´Ø§ÙŠÙÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø¥Ø¹Ù„Ø§Ù†Ø§ØªÙ‡Ù… | **P2** |

---

## ğŸš€ Sprint 1 â€” Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 1-2
### Analytics + Tracking + SEO (Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø£ÙˆÙ„ÙˆÙŠØ© â€” P0)

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 1: ØªØ±ÙƒÙŠØ¨ Google Analytics 4

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/lib/analytics.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/components/providers/GoogleAnalytics.tsx` â† Ø¬Ø¯ÙŠØ¯
- `src/app/layout.tsx` â† ØªØ¹Ø¯ÙŠÙ„ (Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù€ component)

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/lib/analytics.ts
// ============================================
declare global {
  interface Window {
    gtag: (...args: any[]) => void
  }
}

export const GA_TRACKING_ID = process.env.NEXT_PUBLIC_GA_ID

export const pageview = (url: string) => {
  if (typeof window.gtag !== 'undefined') {
    window.gtag('config', GA_TRACKING_ID, { page_path: url })
  }
}

export const event = (action: string, params: Record<string, any> = {}) => {
  if (typeof window.gtag !== 'undefined') {
    window.gtag('event', action, params)
  }
}

// ===== Marketing Events =====

export const trackAdView = (adId: string, category: string, price?: number) =>
  event('view_item', {
    item_id: adId,
    item_category: category,
    value: price,
    currency: 'EGP',
  })

export const trackAdCreate = (category: string) =>
  event('ad_create', { category })

export const trackContact = (type: 'chat' | 'whatsapp' | 'call', adId: string) =>
  event('contact_seller', { method: type, item_id: adId })

export const trackSearch = (query: string, resultsCount: number) =>
  event('search', { search_term: query, results_count: resultsCount })

export const trackShare = (adId: string, method: string) =>
  event('share', { item_id: adId, method })

export const trackSignup = (method: string) =>
  event('sign_up', { method })

export const trackFavorite = (adId: string) =>
  event('add_to_wishlist', { item_id: adId })

export const trackPriceScanner = (query: string) =>
  event('price_scanner_use', { search_term: query })

export const trackInstallPrompt = (action: 'shown' | 'accepted' | 'dismissed') =>
  event('pwa_install', { action })

export const trackReferral = (action: 'share' | 'click' | 'signup' | 'first_ad') =>
  event('referral', { action })
```

```typescript
// ============================================
// src/components/providers/GoogleAnalytics.tsx
// ============================================
'use client'

import Script from 'next/script'
import { usePathname, useSearchParams } from 'next/navigation'
import { useEffect, Suspense } from 'react'
import { GA_TRACKING_ID, pageview } from '@/lib/analytics'

function GoogleAnalyticsInner() {
  const pathname = usePathname()
  const searchParams = useSearchParams()

  useEffect(() => {
    if (pathname) {
      pageview(pathname + (searchParams?.toString() ? `?${searchParams}` : ''))
    }
  }, [pathname, searchParams])

  if (!GA_TRACKING_ID) return null

  return (
    <>
      <Script
        strategy="afterInteractive"
        src={`https://www.googletagmanager.com/gtag/js?id=${GA_TRACKING_ID}`}
      />
      <Script
        id="google-analytics"
        strategy="afterInteractive"
        dangerouslySetInnerHTML={{
          __html: `
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', '${GA_TRACKING_ID}', {
              page_path: window.location.pathname,
              send_page_view: true,
            });
          `,
        }}
      />
    </>
  )
}

export default function GoogleAnalytics() {
  return (
    <Suspense fallback={null}>
      <GoogleAnalyticsInner />
    </Suspense>
  )
}
```

**Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙÙŠ layout.tsx:**
```typescript
// Ø£Ø¶Ù ÙÙŠ src/app/layout.tsx Ø¯Ø§Ø®Ù„ <body>:
import GoogleAnalytics from '@/components/providers/GoogleAnalytics'

// Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ return:
<body>
  <GoogleAnalytics />
  {/* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ */}
</body>
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 2: ØªØ±ÙƒÙŠØ¨ Meta Pixel + Conversions API

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/lib/meta-pixel.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/components/providers/MetaPixel.tsx` â† Ø¬Ø¯ÙŠØ¯
- `src/app/api/meta-capi/route.ts` â† Ø¬Ø¯ÙŠØ¯ (Server-side)
- `src/app/layout.tsx` â† ØªØ¹Ø¯ÙŠÙ„

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/lib/meta-pixel.ts
// ============================================
declare global {
  interface Window {
    fbq: (...args: any[]) => void
  }
}

export const FB_PIXEL_ID = process.env.NEXT_PUBLIC_FB_PIXEL_ID

export const fbPageview = () => {
  if (typeof window.fbq !== 'undefined') {
    window.fbq('track', 'PageView')
  }
}

export const fbTrackViewContent = (adId: string, value: number, category: string) => {
  if (typeof window.fbq !== 'undefined') {
    window.fbq('track', 'ViewContent', {
      content_ids: [adId],
      content_type: 'product',
      value,
      currency: 'EGP',
      content_category: category,
    })
  }
}

export const fbTrackSearch = (query: string) => {
  if (typeof window.fbq !== 'undefined') {
    window.fbq('track', 'Search', { search_string: query })
  }
}

export const fbTrackLead = (adId: string, contactMethod: string) => {
  if (typeof window.fbq !== 'undefined') {
    window.fbq('track', 'Lead', {
      content_ids: [adId],
      content_category: contactMethod,
    })
  }
}

export const fbTrackCompleteRegistration = (method: string) => {
  if (typeof window.fbq !== 'undefined') {
    window.fbq('track', 'CompleteRegistration', { method })
  }
}

export const fbTrackAddToWishlist = (adId: string, value?: number) => {
  if (typeof window.fbq !== 'undefined') {
    window.fbq('track', 'AddToWishlist', {
      content_ids: [adId],
      value,
      currency: 'EGP',
    })
  }
}
```

```typescript
// ============================================
// src/components/providers/MetaPixel.tsx
// ============================================
'use client'

import Script from 'next/script'
import { usePathname } from 'next/navigation'
import { useEffect } from 'react'
import { FB_PIXEL_ID, fbPageview } from '@/lib/meta-pixel'

export default function MetaPixel() {
  const pathname = usePathname()

  useEffect(() => {
    fbPageview()
  }, [pathname])

  if (!FB_PIXEL_ID) return null

  return (
    <Script
      id="meta-pixel"
      strategy="afterInteractive"
      dangerouslySetInnerHTML={{
        __html: `
          !function(f,b,e,v,n,t,s)
          {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
          n.callMethod.apply(n,arguments):n.queue.push(arguments)};
          if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
          n.queue=[];t=b.createElement(e);t.async=!0;
          t.src=v;s=b.getElementsByTagName(e)[0];
          s.parentNode.insertBefore(t,s)}(window, document,'script',
          'https://connect.facebook.net/en_US/fbevents.js');
          fbq('init', '${FB_PIXEL_ID}');
          fbq('track', 'PageView');
        `,
      }}
    />
  )
}
```

```typescript
// ============================================
// src/app/api/meta-capi/route.ts
// ============================================
import { NextRequest, NextResponse } from 'next/server'
import crypto from 'crypto'

const FB_ACCESS_TOKEN = process.env.FB_ACCESS_TOKEN
const FB_PIXEL_ID = process.env.NEXT_PUBLIC_FB_PIXEL_ID

function hashData(data: string): string {
  return crypto.createHash('sha256').update(data.toLowerCase().trim()).digest('hex')
}

export async function POST(req: NextRequest) {
  try {
    const body = await req.json()
    const { eventName, eventData, userData } = body

    const payload = {
      data: [{
        event_name: eventName,
        event_time: Math.floor(Date.now() / 1000),
        event_id: body.eventId || crypto.randomUUID(),
        action_source: 'website',
        event_source_url: body.sourceUrl,
        user_data: {
          client_ip_address: req.headers.get('x-forwarded-for') || req.ip,
          client_user_agent: req.headers.get('user-agent'),
          ...(userData?.email && { em: [hashData(userData.email)] }),
          ...(userData?.phone && { ph: [hashData(userData.phone)] }),
          country: ['842c370ef94d498f576e0346db13296e1e2c48cac6b88da0c0d0284244e8fb6b'], // EG hashed
        },
        custom_data: eventData,
      }],
    }

    const response = await fetch(
      `https://graph.facebook.com/v19.0/${FB_PIXEL_ID}/events?access_token=${FB_ACCESS_TOKEN}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      }
    )

    const result = await response.json()
    return NextResponse.json(result)
  } catch (error) {
    return NextResponse.json({ error: 'Failed to send event' }, { status: 500 })
  }
}
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 3: ØªØ±ÙƒÙŠØ¨ TikTok Pixel

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/lib/tiktok-pixel.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/components/providers/TikTokPixel.tsx` â† Ø¬Ø¯ÙŠØ¯
- `src/app/layout.tsx` â† ØªØ¹Ø¯ÙŠÙ„

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/lib/tiktok-pixel.ts
// ============================================
declare global {
  interface Window {
    ttq: any
  }
}

export const TIKTOK_PIXEL_ID = process.env.NEXT_PUBLIC_TIKTOK_PIXEL_ID

export const ttPageview = () => {
  if (typeof window.ttq !== 'undefined') {
    window.ttq.page()
  }
}

export const ttTrackViewContent = (adId: string, category: string, value?: number) => {
  if (typeof window.ttq !== 'undefined') {
    window.ttq.track('ViewContent', {
      content_id: adId,
      content_type: 'product',
      content_category: category,
      value,
      currency: 'EGP',
    })
  }
}

export const ttTrackSearch = (query: string) => {
  if (typeof window.ttq !== 'undefined') {
    window.ttq.track('Search', { query })
  }
}

export const ttTrackRegistration = () => {
  if (typeof window.ttq !== 'undefined') {
    window.ttq.track('CompleteRegistration')
  }
}

export const ttTrackClickButton = (buttonName: string) => {
  if (typeof window.ttq !== 'undefined') {
    window.ttq.track('ClickButton', { button_name: buttonName })
  }
}
```

```typescript
// ============================================
// src/components/providers/TikTokPixel.tsx
// ============================================
'use client'

import Script from 'next/script'
import { TIKTOK_PIXEL_ID } from '@/lib/tiktok-pixel'

export default function TikTokPixel() {
  if (!TIKTOK_PIXEL_ID) return null

  return (
    <Script
      id="tiktok-pixel"
      strategy="afterInteractive"
      dangerouslySetInnerHTML={{
        __html: `
          !function (w, d, t) {
            w.TiktokAnalyticsObject=t;var ttq=w[t]=w[t]||[];
            ttq.methods=["page","track","identify","instances","debug","on","off","once","ready","alias","group","enableCookie","disableCookie"];
            ttq.setAndDefer=function(t,e){t[e]=function(){t.push([e].concat(Array.prototype.slice.call(arguments,0)))}};
            for(var i=0;i<ttq.methods.length;i++)ttq.setAndDefer(ttq,ttq.methods[i]);
            ttq.instance=function(t){for(var e=ttq._i[t]||[],n=0;n<ttq.methods.length;n++)ttq.setAndDefer(e,ttq.methods[n]);return e};
            ttq.load=function(e,n){var i="https://analytics.tiktok.com/i18n/pixel/events.js";
            ttq._i=ttq._i||{};ttq._i[e]=[];ttq._i[e]._u=i;ttq._t=ttq._t||{};ttq._t[e]=+new Date;ttq._o=ttq._o||{};ttq._o[e]=n||{};
            var o=document.createElement("script");o.type="text/javascript";o.async=!0;o.src=i+"?sdkid="+e+"&lib="+t;
            var a=document.getElementsByTagName("script")[0];a.parentNode.insertBefore(o,a)};
            ttq.load('${TIKTOK_PIXEL_ID}');
            ttq.page();
          }(window, document, 'ttq');
        `,
      }}
    />
  )
}
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 4: UTM Tracking System

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/lib/utm.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/hooks/useUTM.ts` â† Ø¬Ø¯ÙŠØ¯

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/lib/utm.ts
// ============================================
export interface UTMParams {
  utm_source?: string
  utm_medium?: string
  utm_campaign?: string
  utm_term?: string
  utm_content?: string
}

const UTM_KEYS: (keyof UTMParams)[] = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content']
const FIRST_TOUCH_KEY = 'maksab_utm_first'
const LAST_TOUCH_KEY = 'maksab_utm_last'
const UTM_TIME_KEY = 'maksab_utm_time'

export const captureUTM = (): UTMParams => {
  if (typeof window === 'undefined') return {}

  const params = new URLSearchParams(window.location.search)
  const utm: UTMParams = {}

  UTM_KEYS.forEach(key => {
    const val = params.get(key)
    if (val) utm[key] = val
  })

  if (Object.keys(utm).length > 0) {
    // First touch â€” only save if not already set
    if (!localStorage.getItem(FIRST_TOUCH_KEY)) {
      localStorage.setItem(FIRST_TOUCH_KEY, JSON.stringify(utm))
    }
    // Last touch â€” always update
    localStorage.setItem(LAST_TOUCH_KEY, JSON.stringify(utm))
    localStorage.setItem(UTM_TIME_KEY, new Date().toISOString())
  }

  return utm
}

export const getFirstTouchUTM = (): UTMParams | null => {
  if (typeof window === 'undefined') return null
  const stored = localStorage.getItem(FIRST_TOUCH_KEY)
  return stored ? JSON.parse(stored) : null
}

export const getLastTouchUTM = (): UTMParams | null => {
  if (typeof window === 'undefined') return null
  const stored = localStorage.getItem(LAST_TOUCH_KEY)
  return stored ? JSON.parse(stored) : null
}

export const clearUTM = () => {
  if (typeof window === 'undefined') return
  localStorage.removeItem(FIRST_TOUCH_KEY)
  localStorage.removeItem(LAST_TOUCH_KEY)
  localStorage.removeItem(UTM_TIME_KEY)
}
```

```typescript
// ============================================
// src/hooks/useUTM.ts
// ============================================
'use client'

import { useEffect, useState } from 'react'
import { captureUTM, getLastTouchUTM, type UTMParams } from '@/lib/utm'

export function useUTM() {
  const [utm, setUtm] = useState<UTMParams>({})

  useEffect(() => {
    const captured = captureUTM()
    setUtm(Object.keys(captured).length > 0 ? captured : getLastTouchUTM() || {})
  }, [])

  return utm
}
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 5: SEO â€” Dynamic Metadata Ù„ÙƒÙ„ ØµÙØ­Ø©

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/app/ad/[id]/page.tsx` â† ØªØ¹Ø¯ÙŠÙ„ (Ø¥Ø¶Ø§ÙØ© generateMetadata)
- `src/app/search/page.tsx` â† ØªØ¹Ø¯ÙŠÙ„
- `src/app/stores/page.tsx` â† ØªØ¹Ø¯ÙŠÙ„
- `src/app/page.tsx` â† ØªØ¹Ø¯ÙŠÙ„ (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)

**Ø§Ù„ØªÙ†ÙÙŠØ° â€” Ù…Ø«Ø§Ù„ Ù„ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†:**

```typescript
// ============================================
// Ø£Ø¶Ù ÙÙŠ Ø£Ø¹Ù„Ù‰ src/app/ad/[id]/page.tsx
// ============================================
import type { Metadata } from 'next'
import { createClient } from '@/lib/supabase/server'

export async function generateMetadata(
  { params }: { params: Promise<{ id: string }> }
): Promise<Metadata> {
  const { id } = await params
  const supabase = await createClient()
  const { data: ad } = await supabase
    .from('ads')
    .select('title, description, price, location, category, images')
    .eq('id', id)
    .single()

  if (!ad) {
    return {
      title: 'Ù…ÙƒØ³Ø¨ â€” ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨',
      description: 'Ø£ÙˆÙ„ ØªØ·Ø¨ÙŠÙ‚ Ù…ØµØ±ÙŠ Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
    }
  }

  const title = `${ad.title} â€” ${ad.price?.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡ | Ù…ÙƒØ³Ø¨`
  const desc = `${ad.title} Ù„Ù„Ø¨ÙŠØ¹ ÙÙŠ ${ad.location || 'Ù…ØµØ±'}. Ø§Ù„Ø³Ø¹Ø±: ${ad.price?.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡. ${(ad.description || '').slice(0, 120)}`

  return {
    title,
    description: desc,
    keywords: [ad.category, ad.location, 'Ø¨ÙŠØ¹', 'Ø´Ø±Ø§Ø¡', 'Ù…ÙƒØ³Ø¨', 'Ù…ØµØ±', 'Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¨ÙˆØ¨Ø©'].filter(Boolean),
    openGraph: {
      title,
      description: desc,
      images: [{ url: `/api/og?id=${id}`, width: 1200, height: 630 }],
      type: 'website',
      locale: 'ar_EG',
      siteName: 'Ù…ÙƒØ³Ø¨',
    },
    twitter: { card: 'summary_large_image', title, description: desc },
    alternates: { canonical: `https://maksab.vercel.app/ad/${id}` },
  }
}
```

**Metadata Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:**
```typescript
// src/app/page.tsx â€” Ø£Ø¶Ù ÙÙŠ Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù Ø£Ùˆ Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯
export const metadata: Metadata = {
  title: 'Ù…ÙƒØ³Ø¨ â€” ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨ | Ø¨ÙŠØ¹ ÙˆØ´Ø±Ø§Ø¡ ÙÙŠ Ù…ØµØ±',
  description: 'Ø£ÙˆÙ„ ØªØ·Ø¨ÙŠÙ‚ Ù…ØµØ±ÙŠ Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ø³ÙŠØ§Ø±Ø§ØªØŒ Ø¹Ù‚Ø§Ø±Ø§ØªØŒ Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§ØªØŒ Ø°Ù‡Ø¨ ÙˆØ£ÙƒØªØ±. Ø§Ø¹Ø±Ù Ø³Ø¹Ø± Ø£ÙŠ Ø­Ø§Ø¬Ø© Ø¨Ø§Ù„Ù€ AI Ù…Ø¬Ø§Ù†Ø§Ù‹!',
  keywords: ['Ù…ÙƒØ³Ø¨', 'Ø¨ÙŠØ¹', 'Ø´Ø±Ø§Ø¡', 'Ø³ÙŠØ§Ø±Ø§Øª', 'Ø¹Ù‚Ø§Ø±Ø§Øª', 'Ù…ÙˆØ¨Ø§ÙŠÙ„Ø§Øª', 'Ù…ØµØ±', 'Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ø¨ÙˆØ¨Ø©', 'OLX Ø¨Ø¯ÙŠÙ„'],
  openGraph: {
    title: 'Ù…ÙƒØ³Ø¨ â€” ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨',
    description: 'Ø£ÙˆÙ„ ØªØ·Ø¨ÙŠÙ‚ Ù…ØµØ±ÙŠ Ù„Ù„Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
    url: 'https://maksab.vercel.app',
    siteName: 'Ù…ÙƒØ³Ø¨',
    locale: 'ar_EG',
    type: 'website',
  },
}
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 6: Dynamic Sitemap + Robots.txt

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/app/sitemap.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/app/robots.ts` â† Ø¬Ø¯ÙŠØ¯

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/app/sitemap.ts
// ============================================
import type { MetadataRoute } from 'next'
import { createClient } from '@/lib/supabase/server'

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const supabase = await createClient()
  const baseUrl = 'https://maksab.vercel.app'

  // Static pages
  const staticPages: MetadataRoute.Sitemap = [
    { url: baseUrl, lastModified: new Date(), changeFrequency: 'daily', priority: 1.0 },
    { url: `${baseUrl}/search`, lastModified: new Date(), changeFrequency: 'daily', priority: 0.9 },
    { url: `${baseUrl}/stores`, lastModified: new Date(), changeFrequency: 'daily', priority: 0.8 },
    { url: `${baseUrl}/price-scanner`, lastModified: new Date(), changeFrequency: 'weekly', priority: 0.8 },
    { url: `${baseUrl}/map`, lastModified: new Date(), changeFrequency: 'daily', priority: 0.7 },
    { url: `${baseUrl}/help`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.3 },
    { url: `${baseUrl}/privacy`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.2 },
    { url: `${baseUrl}/terms`, lastModified: new Date(), changeFrequency: 'monthly', priority: 0.2 },
  ]

  // Dynamic ad pages
  const { data: ads } = await supabase
    .from('ads')
    .select('id, updated_at')
    .eq('status', 'active')
    .order('updated_at', { ascending: false })
    .limit(5000)

  const adPages: MetadataRoute.Sitemap = (ads || []).map(ad => ({
    url: `${baseUrl}/ad/${ad.id}`,
    lastModified: new Date(ad.updated_at),
    changeFrequency: 'weekly' as const,
    priority: 0.6,
  }))

  // Dynamic store pages
  const { data: stores } = await supabase
    .from('stores')
    .select('id, updated_at')
    .limit(1000)

  const storePages: MetadataRoute.Sitemap = (stores || []).map(store => ({
    url: `${baseUrl}/store/${store.id}`,
    lastModified: new Date(store.updated_at),
    changeFrequency: 'weekly' as const,
    priority: 0.5,
  }))

  return [...staticPages, ...adPages, ...storePages]
}
```

```typescript
// ============================================
// src/app/robots.ts
// ============================================
import type { MetadataRoute } from 'next'

export default function robots(): MetadataRoute.Robots {
  return {
    rules: [
      {
        userAgent: '*',
        allow: '/',
        disallow: ['/api/', '/admin/', '/chat/', '/settings/', '/my-ads/', '/my-offers/'],
      },
    ],
    sitemap: 'https://maksab.vercel.app/sitemap.xml',
  }
}
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 7: Dynamic OG Images

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/app/api/og/route.tsx` â† Ø¬Ø¯ÙŠØ¯

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/app/api/og/route.tsx
// ============================================
import { ImageResponse } from 'next/og'
import { NextRequest } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export const runtime = 'edge'

export async function GET(req: NextRequest) {
  const { searchParams } = req.nextUrl
  const adId = searchParams.get('id')

  let title = 'Ù…ÙƒØ³Ø¨ â€” ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨'
  let price = ''
  let location = ''
  let category = ''

  if (adId) {
    const supabase = await createClient()
    const { data: ad } = await supabase
      .from('ads')
      .select('title, price, location, category')
      .eq('id', adId)
      .single()

    if (ad) {
      title = ad.title || title
      price = ad.price ? `${ad.price.toLocaleString('ar-EG')} Ø¬Ù†ÙŠÙ‡` : ''
      location = ad.location || ''
      category = ad.category || ''
    }
  }

  return new ImageResponse(
    (
      <div
        style={{
          width: '100%',
          height: '100%',
          display: 'flex',
          flexDirection: 'column',
          justifyContent: 'center',
          alignItems: 'center',
          background: 'linear-gradient(135deg, #1B5E20 0%, #2E7D32 50%, #4CAF50 100%)',
          fontFamily: 'Arial, sans-serif',
          direction: 'rtl',
          padding: '40px',
        }}
      >
        <div style={{ fontSize: '32px', color: '#fff', opacity: 0.9, marginBottom: '20px' }}>
          Ù…ÙƒØ³Ø¨ ğŸ’š
        </div>
        <div style={{ fontSize: '48px', color: '#fff', fontWeight: 'bold', textAlign: 'center', marginBottom: '20px', maxWidth: '900px' }}>
          {title}
        </div>
        {price && (
          <div style={{ fontSize: '40px', color: '#FFD600', fontWeight: 'bold', marginBottom: '15px' }}>
            {price}
          </div>
        )}
        {location && (
          <div style={{ fontSize: '24px', color: '#C8E6C9' }}>
            ğŸ“ {location} {category ? `â€¢ ${category}` : ''}
          </div>
        )}
        <div style={{ position: 'absolute', bottom: '30px', fontSize: '20px', color: '#A5D6A7' }}>
          maksab.vercel.app â€” ÙƒÙ„ ØµÙÙ‚Ø© Ù…ÙƒØ³Ø¨
        </div>
      </div>
    ),
    { width: 1200, height: 630 }
  )
}
```

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 8: PWA Install Prompt Ù…Ø­Ø³Ù‘Ù†

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `src/components/InstallPrompt.tsx` â† Ø¬Ø¯ÙŠØ¯
- `src/hooks/useInstallPrompt.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/app/layout.tsx` â† ØªØ¹Ø¯ÙŠÙ„ (Ø¥Ø¶Ø§ÙØ© InstallPrompt)

**Ø§Ù„ØªÙ†ÙÙŠØ°:**

```typescript
// ============================================
// src/hooks/useInstallPrompt.ts
// ============================================
'use client'

import { useState, useEffect } from 'react'

interface BeforeInstallPromptEvent extends Event {
  prompt: () => Promise<void>
  userChoice: Promise<{ outcome: 'accepted' | 'dismissed' }>
}

export function useInstallPrompt() {
  const [deferredPrompt, setDeferredPrompt] = useState<BeforeInstallPromptEvent | null>(null)
  const [isInstallable, setIsInstallable] = useState(false)
  const [isInstalled, setIsInstalled] = useState(false)

  useEffect(() => {
    // Check if already installed
    if (window.matchMedia('(display-mode: standalone)').matches) {
      setIsInstalled(true)
      return
    }

    // Check if dismissed recently
    const dismissedAt = localStorage.getItem('maksab_install_dismissed')
    if (dismissedAt) {
      const daysSinceDismissed = (Date.now() - parseInt(dismissedAt)) / (1000 * 60 * 60 * 24)
      if (daysSinceDismissed < 7) return
    }

    // Track visits
    const visits = parseInt(localStorage.getItem('maksab_visits') || '0') + 1
    localStorage.setItem('maksab_visits', visits.toString())

    // Show after 2nd visit
    if (visits < 2) return

    const handler = (e: Event) => {
      e.preventDefault()
      setDeferredPrompt(e as BeforeInstallPromptEvent)
      setIsInstallable(true)
    }

    window.addEventListener('beforeinstallprompt', handler)
    return () => window.removeEventListener('beforeinstallprompt', handler)
  }, [])

  const install = async () => {
    if (!deferredPrompt) return false
    deferredPrompt.prompt()
    const { outcome } = await deferredPrompt.userChoice
    setDeferredPrompt(null)
    setIsInstallable(false)
    if (outcome === 'accepted') setIsInstalled(true)
    return outcome === 'accepted'
  }

  const dismiss = () => {
    setIsInstallable(false)
    localStorage.setItem('maksab_install_dismissed', Date.now().toString())
  }

  return { isInstallable, isInstalled, install, dismiss }
}
```

```typescript
// ============================================
// src/components/InstallPrompt.tsx
// ============================================
'use client'

import { useInstallPrompt } from '@/hooks/useInstallPrompt'
import { trackInstallPrompt } from '@/lib/analytics'
import { useEffect } from 'react'

export default function InstallPrompt() {
  const { isInstallable, install, dismiss } = useInstallPrompt()

  useEffect(() => {
    if (isInstallable) trackInstallPrompt('shown')
  }, [isInstallable])

  if (!isInstallable) return null

  return (
    <div className="fixed bottom-20 left-4 right-4 z-50 bg-white rounded-2xl shadow-2xl border border-green-200 p-4 flex items-center gap-3 animate-slide-up">
      <div className="w-12 h-12 bg-green-600 rounded-xl flex items-center justify-center text-white text-2xl font-bold flex-shrink-0">
        Ù…
      </div>
      <div className="flex-1 text-right">
        <p className="font-bold text-gray-900 text-sm">Ø­Ù…Ù‘Ù„ Ù…ÙƒØ³Ø¨ Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„Ùƒ</p>
        <p className="text-gray-500 text-xs">Ù…Ø¬Ø§Ù†Ø§Ù‹ ÙˆØ¨Ø¯ÙˆÙ† App Store!</p>
      </div>
      <div className="flex gap-2 flex-shrink-0">
        <button
          onClick={() => { dismiss(); trackInstallPrompt('dismissed') }}
          className="text-gray-400 text-xs px-2 py-1"
        >
          Ù„Ø§Ø­Ù‚Ø§Ù‹
        </button>
        <button
          onClick={async () => {
            const accepted = await install()
            trackInstallPrompt(accepted ? 'accepted' : 'dismissed')
          }}
          className="bg-green-600 text-white text-sm font-bold px-4 py-2 rounded-xl"
        >
          Ø­Ù…Ù‘Ù„ Ø¯Ù„ÙˆÙ‚ØªÙŠ
        </button>
      </div>
    </div>
  )
}
```

---

## ğŸ”„ Sprint 2 â€” Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ 3-4
### Growth Loops + Conversion Optimization (P0-P1)

### Ø§Ù„Ù…Ù‡Ù…Ø© 9: Referral System Ø§Ù„ÙƒØ§Ù…Ù„

**Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:**
- `supabase/migrations/XXXXXX_referral_system.sql` â† Ø¬Ø¯ÙŠØ¯
- `src/lib/referral.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/app/api/referral/track/route.ts` â† Ø¬Ø¯ÙŠØ¯
- `src/app/invite/[code]/page.tsx` â† ØªØ¹Ø¯ÙŠÙ„
- `src/components/ReferralDashboard.tsx` â† Ø¬Ø¯ÙŠØ¯

**SQL Migration:**
```sql
-- supabase/migrations/XXXXXX_referral_system.sql

CREATE TABLE IF NOT EXISTS public.referral_codes (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE,
  code TEXT UNIQUE NOT NULL,
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.referral_events (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  referral_code TEXT NOT NULL REFERENCES public.referral_codes(code),
  event_type TEXT NOT NULL CHECK (event_type IN ('click', 'signup', 'first_ad', 'first_sale')),
  referred_user_id UUID REFERENCES auth.users(id),
  metadata JSONB DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS public.user_points (
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
  total_points INT DEFAULT 0,
  level TEXT DEFAULT 'bronze' CHECK (level IN ('bronze', 'silver', 'gold', 'ambassador')),
  referral_count INT DEFAULT 0,
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_referral_events_code ON public.referral_events(referral_code);
CREATE INDEX idx_referral_codes_user ON public.referral_codes(user_id);

-- Auto-create referral code on signup
CREATE OR REPLACE FUNCTION public.create_referral_code()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.referral_codes (user_id, code)
  VALUES (NEW.id, 'MKS' || UPPER(SUBSTRING(NEW.id::TEXT, 1, 6)));
  INSERT INTO public.user_points (user_id) VALUES (NEW.id);
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE TRIGGER on_auth_user_created_referral
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.create_referral_code();

-- Add points function
CREATE OR REPLACE FUNCTION public.add_points(
  p_user_id UUID,
  p_points INT,
  p_reason TEXT DEFAULT ''
) RETURNS VOID AS $$
BEGIN
  INSERT INTO public.user_points (user_id, total_points)
  VALUES (p_user_id, p_points)
  ON CONFLICT (user_id) DO UPDATE SET
    total_points = user_points.total_points + p_points,
    referral_count = CASE WHEN p_reason = 'referral_signup' THEN user_points.referral_count + 1 ELSE user_points.referral_count END,
    level = CASE
      WHEN user_points.total_points + p_points >= 1000 THEN 'ambassador'
      WHEN user_points.total_points + p_points >= 500 THEN 'gold'
      WHEN user_points.total_points + p_points >= 100 THEN 'silver'
      ELSE 'bronze'
    END,
    updated_at = now();
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

**Points System:**
| Ø§Ù„Ø­Ø¯Ø« | Ø§Ù„Ù†Ù‚Ø§Ø· |
|-------|--------|
| ØµØ§Ø­Ø¨Ùƒ Ø³Ø¬Ù‘Ù„ (referral signup) | 10 |
| ØµØ§Ø­Ø¨Ùƒ Ù†Ø´Ø± Ø£ÙˆÙ„ Ø¥Ø¹Ù„Ø§Ù† | 25 |
| ØµØ§Ø­Ø¨Ùƒ Ø¹Ù…Ù„ Ø£ÙˆÙ„ ØµÙÙ‚Ø© | 50 |
| Ø£Ù†Øª Ù†Ø´Ø±Øª Ø¥Ø¹Ù„Ø§Ù† | 5 |
| Ø£Ù†Øª Ø£Ø¶ÙØª ØªÙ‚ÙŠÙŠÙ… | 3 |

**Levels:**
| Ø§Ù„Ù…Ø³ØªÙˆÙ‰ | Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© | Ø§Ù„Ù…ÙƒØ§ÙØ£Ø© |
|---------|----------------|---------|
| Ø¨Ø±ÙˆÙ†Ø² ğŸ¥‰ | 0-99 | â€” |
| ÙØ¶ÙŠ ğŸ¥ˆ | 100-499 | Ø¥Ø¹Ù„Ø§Ù† Ù…Ù…ÙŠØ² Ù…Ø¬Ø§Ù†ÙŠ |
| Ø°Ù‡Ø¨ÙŠ ğŸ¥‡ | 500-999 | Ø´Ù‡Ø± Premium Ù…Ø¬Ø§Ù†ÙŠ |
| Ø³ÙÙŠØ± ğŸ† | 1000+ | Ù‡Ø¯ÙŠØ© ÙØ¹Ù„ÙŠØ© + Badge Ø¯Ø§Ø¦Ù… |

---

### Ø§Ù„Ù…Ù‡Ù…Ø© 10: WhatsApp Share Ù…Ø­Ø³Ù‘Ù†
- Pre-filled message Ù…Ø¹ OG preview
- Deep link: `https://wa.me/?text=...`
- Track shares ÙÙŠ GA4

### Ø§Ù„Ù…Ù‡Ù…Ø© 11: A/B Testing Framework
- Consistent user bucketing Ù…Ø¹ Zustand
- Track variant + conversion ÙÙŠ GA4
- Ø£ÙˆÙ„ ØªØ¬Ø±Ø¨Ø©: CTA button color

### Ø§Ù„Ù…Ù‡Ù…Ø© 12: Onboarding Flow Ù…Ø­Ø³Ù‘Ù†
- 4 Ø®Ø·ÙˆØ§Øª Ø¨Ù€ Framer Motion
- Progress bar + Skip option
- Track completion rate

### Ø§Ù„Ù…Ù‡Ù…Ø© 13: Smart Push Notifications
- Firebase Cloud Messaging campaigns
- Trigger-based: Welcome, Nudge, Category Alert, Chat, Price Drop

### Ø§Ù„Ù…Ù‡Ù…Ø© 14: CRO â€” ØªØ­Ø³ÙŠÙ† ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
- Sticky CTA bar (Ù…ÙˆØ¨Ø§ÙŠÙ„)
- Social proof: "[Ø¹Ø¯Ø¯] Ø´Ø®Øµ Ø´Ø§Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†"
- Lazy loading + Skeleton

### Ø§Ù„Ù…Ù‡Ù…Ø© 15: Landing Pages Template
- `/campaign/[slug]` â€” Hero + Benefits + CTA
- UTM tracking Ù…Ø¯Ù…Ø¬

### Ø§Ù„Ù…Ù‡Ù…Ø© 16: Email Capture + Welcome Flow
- Popup Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
- Ø¬Ø¯ÙˆÙ„ email_subscribers + Welcome email

---

## ğŸ® Sprint 3 â€” Ø§Ù„Ø´Ù‡Ø± 2
### Gamification + Advanced Analytics (P2)

### Ø§Ù„Ù…Ù‡Ù…Ø© 17: Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (Gamification)
### Ø§Ù„Ù…Ù‡Ù…Ø© 18: Structured Data JSON-LD
### Ø§Ù„Ù…Ù‡Ù…Ø© 19: PostHog Integration (Ù…Ø¬Ø§Ù†ÙŠ)
### Ø§Ù„Ù…Ù‡Ù…Ø© 20: Seller Analytics Dashboard
### Ø§Ù„Ù…Ù‡Ù…Ø© 21: Smart Search + Autocomplete
### Ø§Ù„Ù…Ù‡Ù…Ø© 22: Performance Optimization

---

## ğŸ” Environment Variables

Ø£Ø¶Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ `.env.local` ÙˆÙÙŠ Vercel Dashboard:

```env
# ===== Sprint 1: Analytics & Tracking =====
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
NEXT_PUBLIC_FB_PIXEL_ID=XXXXXXXXXXXXXXX
FB_ACCESS_TOKEN=XXXXXXXXXXXXXXX
NEXT_PUBLIC_TIKTOK_PIXEL_ID=XXXXXXXXXXXXXXX

# ===== Sprint 2: Email (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) =====
RESEND_API_KEY=re_XXXXXXXXXXXXXXX

# ===== Sprint 3: PostHog (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) =====
NEXT_PUBLIC_POSTHOG_KEY=phc_XXXXXXXXXXXXXXX
NEXT_PUBLIC_POSTHOG_HOST=https://app.posthog.com
```

---

## ğŸ“ ØªØ¹Ù„ÙŠÙ…Ø§Øª Claude Ù„Ù„ØªØ³ÙˆÙŠÙ‚

### Ø§Ù„Ù…Ø¨Ø§Ø¯Ø¦:
1. **Track everything** â€” Ø£ÙŠ Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠÙ‡Ø§ analytics events
2. **Mobile-first** â€” 90% Ù…Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ù…ØµØ±ÙŠÙŠÙ† Ø¹Ù„Ù‰ Ù…ÙˆØ¨Ø§ÙŠÙ„
3. **Speed = Money** â€” ÙƒÙ„ Ø«Ø§Ù†ÙŠØ© ØªØ­Ù…ÙŠÙ„ = 7% Ø®Ø³Ø§Ø±Ø© conversion
4. **Arabic-first** â€” ÙƒÙ„ Ù†Øµ Ø¨Ø§Ù„Ø¹Ø§Ù…ÙŠØ© Ø§Ù„Ù…ØµØ±ÙŠØ©ØŒ RTL-native
5. **Test everything** â€” A/B test Ø£ÙŠ CTA Ø£Ùˆ copy Ù…Ù‡Ù…

### Checklist Ù„Ø£ÙŠ Ù…ÙŠØ²Ø© Ø¬Ø¯ÙŠØ¯Ø©:
- [ ] GA4 events tracking
- [ ] Meta Pixel events
- [ ] SEO metadata
- [ ] OG tags Ù„Ù„Ù…Ø´Ø§Ø±ÙƒØ©
- [ ] Mobile responsive
- [ ] Skeleton loading
- [ ] Error handling
- [ ] RTL support

---

## ğŸ“Š Marketing Events Standard

```typescript
// ÙƒÙ„ event Ù„Ø§Ø²Ù… ÙŠØªØ¨Ø¹ Ù‡Ø°Ø§ Ø§Ù„Ù€ Pattern:
// GA4:
analytics.event('event_name', {
  item_id: string,        // ID Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
  item_category: string,  // Ø§Ù„Ù‚Ø³Ù…
  value: number,          // Ø§Ù„Ø³Ø¹Ø± Ø¨Ø§Ù„Ø¬Ù†ÙŠÙ‡
  currency: 'EGP',
  method: string,         // Ø§Ù„Ø·Ø±ÙŠÙ‚Ø©
})

// Meta Pixel:
fbq('track', 'EventName', { content_ids: [id], value, currency: 'EGP' })

// TikTok:
ttq.track('EventName', { content_id: id, value, currency: 'EGP' })
```

---

## ğŸ“ˆ KPIs

| Ø§Ù„Ù…Ø¤Ø´Ø± | Ø§Ù„Ù‡Ø¯Ù | Ø§Ù„Ù‚ÙŠØ§Ø³ |
|--------|-------|--------|
| Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© | 1,000 | GA4 + App Store |
| CAC | Ø£Ù‚Ù„ Ù…Ù† 5 Ø¬.Ù… | Meta Ads / Installs |
| Ù…Ø¹Ø¯Ù„ Ø§Ù„ØªÙØ¹ÙŠÙ„ (Ø£ÙˆÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø®Ù„Ø§Ù„ 7 Ø£ÙŠØ§Ù…) | 30% | GA4 events |
| D7 Retention | 25% | GA4 cohorts |
| D30 Retention | 15% | GA4 cohorts |
| Engagement Rate | ÙÙˆÙ‚ 5% | GA4 |
| Organic Traffic Ø´Ù‡Ø±ÙŠØ§Ù‹ | 100,000 | GA4 |
| Referral Rate | 30% Ù…Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª | Supabase |
| Monthly Revenue | 100,000 Ø¬.Ù… | Supabase |
| Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ§Ø¡ | 50 | Supabase |

---

## ğŸ’° Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©

| Ø§Ù„Ø¨Ù†Ø¯ | Ø´Ù‡Ø±ÙŠØ§Ù‹ |
|-------|--------|
| Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Meta | 60,000 Ø¬.Ù… |
| Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Google | 25,000 Ø¬.Ù… |
| Ø¥Ø¹Ù„Ø§Ù†Ø§Øª TikTok | 15,000 Ø¬.Ù… |
| Influencers | 20,000 Ø¬.Ù… |
| Referral Rewards | 15,000 Ø¬.Ù… |
| Content Production | 5,000 Ø¬.Ù… |
| Tools & Analytics | 3,000 Ø¬.Ù… |
| Events & PR | 10,000 Ø¬.Ù… |
| **Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ** | **~153,000 Ø¬.Ù…** |
| **Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ** | **~47,000 Ø¬.Ù…** |

---

> **Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«:** ÙØ¨Ø±Ø§ÙŠØ± 2026
> **CMO:** AI-Powered Marketing | **Developer:** Claude Code
